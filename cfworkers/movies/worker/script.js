!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){"use strict";(function(e){function n(){return"function"==typeof WebSocketPair}function a(){try{return void 0!==e.versions.node}catch(e){return!1}}r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return a}))}).call(this,r(5))},function(e,t,r){"use strict";r.r(t),r.d(t,"compactDecrypt",(function(){return Oe})),r.d(t,"flattenedDecrypt",(function(){return Je})),r.d(t,"generalDecrypt",(function(){return Re})),r.d(t,"GeneralEncrypt",(function(){return Ge})),r.d(t,"compactVerify",(function(){return $e})),r.d(t,"flattenedVerify",(function(){return ze})),r.d(t,"generalVerify",(function(){return Ye})),r.d(t,"jwtVerify",(function(){return tt})),r.d(t,"jwtDecrypt",(function(){return rt})),r.d(t,"CompactEncrypt",(function(){return nt})),r.d(t,"FlattenedEncrypt",(function(){return je})),r.d(t,"CompactSign",(function(){return ot})),r.d(t,"FlattenedSign",(function(){return it})),r.d(t,"GeneralSign",(function(){return ct})),r.d(t,"SignJWT",(function(){return ut})),r.d(t,"EncryptJWT",(function(){return pt})),r.d(t,"calculateJwkThumbprint",(function(){return lt})),r.d(t,"EmbeddedJWK",(function(){return yt})),r.d(t,"createLocalJWKSet",(function(){return gt})),r.d(t,"createRemoteJWKSet",(function(){return St})),r.d(t,"UnsecuredJWT",(function(){return vt})),r.d(t,"exportPKCS8",(function(){return Ue})),r.d(t,"exportSPKI",(function(){return Ie})),r.d(t,"exportJWK",(function(){return xe})),r.d(t,"importSPKI",(function(){return be})),r.d(t,"importPKCS8",(function(){return _e})),r.d(t,"importX509",(function(){return He})),r.d(t,"importJWK",(function(){return Ce})),r.d(t,"decodeProtectedHeader",(function(){return _t})),r.d(t,"decodeJwt",(function(){return Ct})),r.d(t,"errors",(function(){return n})),r.d(t,"generateKeyPair",(function(){return Kt})),r.d(t,"generateSecret",(function(){return kt})),r.d(t,"base64url",(function(){return a}));var n={};r.r(n),r.d(n,"JOSEError",(function(){return E})),r.d(n,"JWTClaimValidationFailed",(function(){return A})),r.d(n,"JWTExpired",(function(){return S})),r.d(n,"JOSEAlgNotAllowed",(function(){return v})),r.d(n,"JOSENotSupported",(function(){return b})),r.d(n,"JWEDecryptionFailed",(function(){return H})),r.d(n,"JWEInvalid",(function(){return _})),r.d(n,"JWSInvalid",(function(){return C})),r.d(n,"JWTInvalid",(function(){return P})),r.d(n,"JWKInvalid",(function(){return K})),r.d(n,"JWKSInvalid",(function(){return k})),r.d(n,"JWKSNoMatchingKey",(function(){return W})),r.d(n,"JWKSMultipleMatchingKeys",(function(){return T})),r.d(n,"JWKSTimeout",(function(){return J})),r.d(n,"JWSSignatureVerificationFailed",(function(){return O}));var a={};r.r(a),r.d(a,"encode",(function(){return bt})),r.d(a,"decode",(function(){return Ht}));var i=crypto;const o=e=>e instanceof CryptoKey;var s=async(e,t)=>{const r="SHA-"+e.slice(-3);return new Uint8Array(await i.subtle.digest(r,t))};const c=new TextEncoder,d=new TextDecoder;function u(...e){const t=e.reduce((e,{length:t})=>e+t,0),r=new Uint8Array(t);let n=0;return e.forEach(e=>{r.set(e,n),n+=e.length}),r}function p(e,t,r){if(t<0||t>=2**32)throw new RangeError("value must be >= 0 and <= 4294967295. Received "+t);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function h(e){const t=Math.floor(e/2**32),r=e%2**32,n=new Uint8Array(8);return p(n,t,0),p(n,r,4),n}function l(e){const t=new Uint8Array(4);return p(t,e),t}function y(e){return u(l(e.length),e)}const w=e=>{let t=e;"string"==typeof t&&(t=c.encode(t));const r=[];for(let e=0;e<t.length;e+=32768)r.push(String.fromCharCode.apply(null,t.subarray(e,e+32768)));return btoa(r.join(""))},f=e=>w(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"),m=e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r},g=e=>{let t=e;t instanceof Uint8Array&&(t=d.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return m(t)}catch(e){throw new TypeError("The input to be decoded is not correctly encoded.")}};class E extends Error{constructor(e){var t;super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,null===(t=Error.captureStackTrace)||void 0===t||t.call(Error,this,this.constructor)}static get code(){return"ERR_JOSE_GENERIC"}}class A extends E{constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=t,this.reason=r}static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}}class S extends E{constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_EXPIRED",this.claim=t,this.reason=r}static get code(){return"ERR_JWT_EXPIRED"}}class v extends E{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class b extends E{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class H extends E{constructor(){super(...arguments),this.code="ERR_JWE_DECRYPTION_FAILED",this.message="decryption operation failed"}static get code(){return"ERR_JWE_DECRYPTION_FAILED"}}class _ extends E{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}static get code(){return"ERR_JWE_INVALID"}}class C extends E{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class P extends E{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class K extends E{constructor(){super(...arguments),this.code="ERR_JWK_INVALID"}static get code(){return"ERR_JWK_INVALID"}}class k extends E{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}static get code(){return"ERR_JWKS_INVALID"}}class W extends E{constructor(){super(...arguments),this.code="ERR_JWKS_NO_MATCHING_KEY",this.message="no applicable key found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_NO_MATCHING_KEY"}}class T extends E{constructor(){super(...arguments),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS",this.message="multiple matching keys found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}class J extends E{constructor(){super(...arguments),this.code="ERR_JWKS_TIMEOUT",this.message="request timed out"}static get code(){return"ERR_JWKS_TIMEOUT"}}class O extends E{constructor(){super(...arguments),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}var R=i.getRandomValues.bind(i);function D(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new b("Unsupported JWE Algorithm: "+e)}}var I=e=>R(new Uint8Array(D(e)>>3));var U=(e,t)=>{if(t.length<<3!==D(e))throw new _("Invalid Initialization Vector length")};var x=(e,t)=>{if(e.length<<3!==t)throw new _("Invalid Content Encryption Key length")};var M=(e,t)=>{if(!(e instanceof Uint8Array))throw new TypeError("First argument must be a buffer");if(!(t instanceof Uint8Array))throw new TypeError("Second argument must be a buffer");if(e.length!==t.length)throw new TypeError("Input buffers must have the same length");const r=e.length;let n=0,a=-1;for(;++a<r;)n|=e[a]^t[a];return 0===n},N=r(0);function j(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function B(e,t){return e.name===t}function G(e){return parseInt(e.name.slice(4),10)}function L(e,t){if(t.length&&!t.some(t=>e.usages.includes(t))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=t[0]+".";throw new TypeError(e)}}function V(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!B(e.algorithm,"HMAC"))throw j("HMAC");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw j("SHA-"+r,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!B(e.algorithm,"RSASSA-PKCS1-v1_5"))throw j("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw j("SHA-"+r,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!B(e.algorithm,"RSA-PSS"))throw j("RSA-PSS");const r=parseInt(t.slice(2),10);if(G(e.algorithm.hash)!==r)throw j("SHA-"+r,"algorithm.hash");break}case Object(N.b)()&&"EdDSA":if("NODE-ED25519"!==e.algorithm.name&&"NODE-ED448"!==e.algorithm.name)throw j("NODE-ED25519 or NODE-ED448");break;case Object(N.a)()&&"EdDSA":if(!B(e.algorithm,"NODE-ED25519"))throw j("NODE-ED25519");break;case"ES256":case"ES384":case"ES512":{if(!B(e.algorithm,"ECDSA"))throw j("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw j(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}L(e,r)}function F(e,t,...r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!B(e.algorithm,"AES-GCM"))throw j("AES-GCM");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw j(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!B(e.algorithm,"AES-KW"))throw j("AES-KW");const r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw j(r,"algorithm.length");break}case"ECDH":if(!B(e.algorithm,"ECDH"))throw j("ECDH");break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!B(e.algorithm,"PBKDF2"))throw j("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!B(e.algorithm,"RSA-OAEP"))throw j("RSA-OAEP");const r=parseInt(t.slice(9),10)||1;if(G(e.algorithm.hash)!==r)throw j("SHA-"+r,"algorithm.hash");break}default:throw new TypeError("CryptoKey does not support this operation")}L(e,r)}var z=(e,...t)=>{let r="Key must be ";if(t.length>2){const e=t.pop();r+=`one of type ${t.join(", ")}, or ${e}.`}else 2===t.length?r+=`one of type ${t[0]} or ${t[1]}.`:r+=`of type ${t[0]}.`;return null==e?r+=" Received "+e:"function"==typeof e&&e.name?r+=" Received function "+e.name:"object"==typeof e&&null!=e&&e.constructor&&e.constructor.name&&(r+=" Received an instance of "+e.constructor.name),r},$=e=>o(e);const Y=["CryptoKey"];var q=async(e,t,r,n,a,s)=>{if(!(o(t)||t instanceof Uint8Array))throw new TypeError(z(t,...Y,"Uint8Array"));switch(U(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return t instanceof Uint8Array&&x(t,parseInt(e.slice(-3),10)),async function(e,t,r,n,a,o){if(!(t instanceof Uint8Array))throw new TypeError(z(t,"Uint8Array"));const s=parseInt(e.slice(1,4),10),c=await i.subtle.importKey("raw",t.subarray(s>>3),"AES-CBC",!1,["decrypt"]),d=await i.subtle.importKey("raw",t.subarray(0,s>>3),{hash:"SHA-"+(s<<1),name:"HMAC"},!1,["sign"]),p=u(o,n,r,h(o.length<<3)),l=new Uint8Array((await i.subtle.sign("HMAC",d,p)).slice(0,s>>3));let y,w;try{y=M(a,l)}catch(e){}if(!y)throw new H;try{w=new Uint8Array(await i.subtle.decrypt({iv:n,name:"AES-CBC"},c,r))}catch(e){}if(!w)throw new H;return w}(e,t,r,n,a,s);case"A128GCM":case"A192GCM":case"A256GCM":return t instanceof Uint8Array&&x(t,parseInt(e.slice(1,4),10)),async function(e,t,r,n,a,o){let s;t instanceof Uint8Array?s=await i.subtle.importKey("raw",t,"AES-GCM",!1,["decrypt"]):(F(t,e,"decrypt"),s=t);try{return new Uint8Array(await i.subtle.decrypt({additionalData:o,iv:n,name:"AES-GCM",tagLength:128},s,u(r,a)))}catch(e){throw new H}}(e,t,r,n,a,s);default:throw new b("Unsupported JWE Content Encryption Algorithm")}};const X=async()=>{throw new b('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime. You need to use the `inflateRaw` decrypt option to provide Inflate Raw implementation.')},Z=async()=>{throw new b('JWE "zip" (Compression Algorithm) Header Parameter is not supported by your javascript runtime. You need to use the `deflateRaw` encrypt option to provide Deflate Raw implementation.')};var Q=(...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0};function ee(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}var te=[{hash:"SHA-256",name:"HMAC"},!0,["sign"]];function re(e,t){if(e.algorithm.length!==parseInt(t.slice(1,4),10))throw new TypeError("Invalid key size for alg: "+t)}function ne(e,t,r){if(o(e))return F(e,t,r),e;if(e instanceof Uint8Array)return i.subtle.importKey("raw",e,"AES-KW",!0,[r]);throw new TypeError(z(e,...Y,"Uint8Array"))}const ae=async(e,t,r)=>{const n=await ne(t,e,"wrapKey");re(n,e);const a=await i.subtle.importKey("raw",r,...te);return new Uint8Array(await i.subtle.wrapKey("raw",a,n,"AES-KW"))},ie=async(e,t,r)=>{const n=await ne(t,e,"unwrapKey");re(n,e);const a=await i.subtle.unwrapKey("raw",r,n,"AES-KW",...te);return new Uint8Array(await i.subtle.exportKey("raw",a))};async function oe(e,t,r,n,a=new Uint8Array(0),d=new Uint8Array(0)){if(!o(e))throw new TypeError(z(e,...Y));if(F(e,"ECDH"),!o(t))throw new TypeError(z(t,...Y));F(t,"ECDH","deriveBits");const p=u(y(c.encode(r)),y(a),y(d),l(n));return async function(e,t,r){const n=Math.ceil((t>>3)/32),a=new Uint8Array(32*n);for(let t=0;t<n;t++){const n=new Uint8Array(4+e.length+r.length);n.set(l(t+1)),n.set(e,4),n.set(r,4+e.length),a.set(await s("sha256",n),32*t)}return a.slice(0,t>>3)}(new Uint8Array(await i.subtle.deriveBits({name:"ECDH",public:e},t,Math.ceil(parseInt(t.algorithm.namedCurve.slice(-3),10)/8)<<3)),n,p)}function se(e){if(!o(e))throw new TypeError(z(e,...Y));return["P-256","P-384","P-521"].includes(e.algorithm.namedCurve)}async function ce(e,t,r,n){!function(e){if(!(e instanceof Uint8Array)||e.length<8)throw new _("PBES2 Salt Input must be 8 or more octets")}(e);const a=function(e,t){return u(c.encode(e),new Uint8Array([0]),t)}(t,e),s=parseInt(t.slice(13,16),10),d={hash:"SHA-"+t.slice(8,11),iterations:r,name:"PBKDF2",salt:a},p={length:s,name:"AES-KW"},h=await function(e,t){if(e instanceof Uint8Array)return i.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits"]);if(o(e))return F(e,t,"deriveBits","deriveKey"),e;throw new TypeError(z(e,...Y,"Uint8Array"))}(n,t);if(h.usages.includes("deriveBits"))return new Uint8Array(await i.subtle.deriveBits(d,h,s));if(h.usages.includes("deriveKey"))return i.subtle.deriveKey(d,h,p,!1,["wrapKey","unwrapKey"]);throw new TypeError('PBKDF2 key "usages" must include "deriveBits" or "deriveKey"')}function de(e){switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return"RSA-OAEP";default:throw new b(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}var ue=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(e+" requires key modulusLength to be 2048 bits or larger")}};function pe(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new b("Unsupported JWE Algorithm: "+e)}}var he=e=>R(new Uint8Array(pe(e)>>3)),le=(e,t)=>`-----BEGIN ${t}-----\n${(e.match(/.{1,64}/g)||[]).join("\n")}\n-----END ${t}-----`;const ye=async(e,t,r)=>{if(!o(r))throw new TypeError(z(r,...Y));if(!r.extractable)throw new TypeError("CryptoKey is not extractable");if(r.type!==e)throw new TypeError(`key is not a ${e} key`);return le(w(new Uint8Array(await i.subtle.exportKey(t,r))),e.toUpperCase()+" KEY")},we=(e,t,r=0)=>{0===r&&(t.unshift(t.length),t.unshift(6));let n=e.indexOf(t[0],r);if(-1===n)return!1;const a=e.subarray(n,n+t.length);return a.length===t.length&&(a.every((e,r)=>e===t[r])||we(e,t,n+1))},fe=e=>{switch(!0){case we(e,[42,134,72,206,61,3,1,7]):return"P-256";case we(e,[43,129,4,0,34]):return"P-384";case we(e,[43,129,4,0,35]):return"P-521";case(Object(N.a)()||Object(N.b)())&&we(e,[43,101,112]):return"Ed25519";case Object(N.b)()&&we(e,[43,101,113]):return"Ed448";default:throw new b("Invalid or unsupported EC Key Curve or OKP Key Sub Type")}},me=async(e,t,r,n,a)=>{var o;let s,c;const d=new Uint8Array(atob(r.replace(e,"")).split("").map(e=>e.charCodeAt(0))),u="spki"===t;switch(n){case"PS256":case"PS384":case"PS512":s={name:"RSA-PSS",hash:"SHA-"+n.slice(-3)},c=u?["verify"]:["sign"];break;case"RS256":case"RS384":case"RS512":s={name:"RSASSA-PKCS1-v1_5",hash:"SHA-"+n.slice(-3)},c=u?["verify"]:["sign"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":s={name:"RSA-OAEP",hash:"SHA-"+(parseInt(n.slice(-3),10)||1)},c=u?["encrypt","wrapKey"]:["decrypt","unwrapKey"];break;case"ES256":s={name:"ECDSA",namedCurve:"P-256"},c=u?["verify"]:["sign"];break;case"ES384":s={name:"ECDSA",namedCurve:"P-384"},c=u?["verify"]:["sign"];break;case"ES512":s={name:"ECDSA",namedCurve:"P-521"},c=u?["verify"]:["sign"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":s={name:"ECDH",namedCurve:fe(d)},c=u?[]:["deriveBits"];break;case(Object(N.a)()||Object(N.b)())&&"EdDSA":const e=fe(d).toUpperCase();s={name:"NODE-"+e,namedCurve:"NODE-"+e},c=u?["verify"]:["sign"];break;default:throw new b('Invalid or unsupported "alg" (Algorithm) value')}return i.subtle.importKey(t,d,s,null!==(o=null==a?void 0:a.extractable)&&void 0!==o&&o,c)},ge=(e,t,r)=>me(/(?:-----(?:BEGIN|END) PUBLIC KEY-----|\s)/g,"spki",e,t,r);var Ee=async e=>{var t,r;const{algorithm:n,keyUsages:a}=function(e){let t,r;switch(e.kty){case"oct":switch(e.alg){case"HS256":case"HS384":case"HS512":t={name:"HMAC",hash:"SHA-"+e.alg.slice(-3)},r=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":throw new b(e.alg+" keys cannot be imported as CryptoKey instances");case"A128GCM":case"A192GCM":case"A256GCM":case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":t={name:"AES-GCM"},r=["encrypt","decrypt"];break;case"A128KW":case"A192KW":case"A256KW":t={name:"AES-KW"},r=["wrapKey","unwrapKey"];break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":t={name:"PBKDF2"},r=["deriveBits"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:"SHA-"+e.alg.slice(-3)},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:"SHA-"+e.alg.slice(-3)},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:"SHA-"+(parseInt(e.alg.slice(-3),10)||1)},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case(Object(N.a)()||Object(N.b)())&&"OKP":if("EdDSA"!==e.alg)throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value');switch(e.crv){case"Ed25519":t={name:"NODE-ED25519",namedCurve:"NODE-ED25519"},r=e.d?["sign"]:["verify"];break;case Object(N.b)()&&"Ed448":t={name:"NODE-ED448",namedCurve:"NODE-ED448"},r=e.d?["sign"]:["verify"];break;default:throw new b('Invalid or unsupported JWK "crv" (Subtype of Key Pair) Parameter value')}break;default:throw new b('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),o=[n,null!==(t=e.ext)&&void 0!==t&&t,null!==(r=e.key_ops)&&void 0!==r?r:a];if("PBKDF2"===n.name)return i.subtle.importKey("raw",g(e.k),...o);const s={...e};return delete s.alg,i.subtle.importKey("jwk",s,...o)};function Ae(e){let t=[],r=0;for(;r<e.length;){let n=Se(e.subarray(r));t.push(n),r+=n.byteLength}return t}function Se(e){let t=0,r=31&e[0];if(t++,31===r){for(r=0;e[t]>=128;)r=128*r+e[t]-128,t++;r=128*r+e[t]-128,t++}let n=0;if(e[t]<128)n=e[t],t++;else{let r=127&e[t];t++,n=0;for(let a=0;a<r;a++)n=256*n+e[t],t++}if(128===n){for(n=0;0!==e[t+n]||0!==e[t+n+1];)n++;const r=t+n+2;return{byteLength:r,contents:e.subarray(t,t+n),raw:e.subarray(0,r)}}const a=t+n;return{byteLength:a,contents:e.subarray(t,a),raw:e.subarray(0,a)}}function ve(e){const t=e.replace(/(?:-----(?:BEGIN|END) CERTIFICATE-----|\s)/g,""),r=m(t);return le(function(e){const t=Ae(Ae(Se(e).contents)[0].contents);return w(t[160===t[0].raw[0]?6:5].raw)}(r),"PUBLIC KEY")}async function be(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PUBLIC KEY-----"))throw new TypeError('"spki" must be SPKI formatted string');return ge(e,t,r)}async function He(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN CERTIFICATE-----"))throw new TypeError('"x509" must be X.509 formatted string');const n=ve(e);return ge(n,t,r)}async function _e(e,t,r){if("string"!=typeof e||0!==e.indexOf("-----BEGIN PRIVATE KEY-----"))throw new TypeError('"pkcs8" must be PCKS8 formatted string');return((e,t,r)=>me(/(?:-----(?:BEGIN|END) PRIVATE KEY-----|\s)/g,"pkcs8",e,t,r))(e,t,r)}async function Ce(e,t,r){if(!ee(e))throw new TypeError("JWK must be an object");if(t||(t=e.alg),"string"!=typeof t||!t)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');switch(e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return null!=r||(r=!0!==e.ext),r?Ee({...e,alg:t,ext:!1}):g(e.k);case"RSA":if(void 0!==e.oth)throw new b('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return Ee({...e,alg:t});default:throw new b('Unsupported "kty" (Key Type) Parameter value')}}var Pe=(e,t,r)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?(e=>{if(!(e instanceof Uint8Array)){if(!$(e))throw new TypeError(z(e,...Y,"Uint8Array"));if("secret"!==e.type)throw new TypeError(Y.join(" or ")+' instances for symmetric algorithms must be of type "secret"')}})(t):((e,t)=>{if(!$(e))throw new TypeError(z(e,...Y));if("secret"===e.type)throw new TypeError(Y.join(" or ")+' instances for asymmetric algorithms must not be of type "secret"');if("sign"===t&&"public"===e.type)throw new TypeError(Y.join(" or ")+' instances for asymmetric algorithm signing must be of type "private"');if("decrypt"===t&&"public"===e.type)throw new TypeError(Y.join(" or ")+' instances for asymmetric algorithm decryption must be of type "private"');if(e.algorithm&&"verify"===t&&"private"===e.type)throw new TypeError(Y.join(" or ")+' instances for asymmetric algorithm verifying must be of type "public"');if(e.algorithm&&"encrypt"===t&&"private"===e.type)throw new TypeError(Y.join(" or ")+' instances for asymmetric algorithm encryption must be of type "public"')})(t,r)};var Ke=async(e,t,r,n,a)=>{if(!(o(r)||r instanceof Uint8Array))throw new TypeError(z(r,...Y,"Uint8Array"));switch(U(e,n),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return r instanceof Uint8Array&&x(r,parseInt(e.slice(-3),10)),async function(e,t,r,n,a){if(!(r instanceof Uint8Array))throw new TypeError(z(r,"Uint8Array"));const o=parseInt(e.slice(1,4),10),s=await i.subtle.importKey("raw",r.subarray(o>>3),"AES-CBC",!1,["encrypt"]),c=await i.subtle.importKey("raw",r.subarray(0,o>>3),{hash:"SHA-"+(o<<1),name:"HMAC"},!1,["sign"]),d=new Uint8Array(await i.subtle.encrypt({iv:n,name:"AES-CBC"},s,t)),p=u(a,n,d,h(a.length<<3));return{ciphertext:d,tag:new Uint8Array((await i.subtle.sign("HMAC",c,p)).slice(0,o>>3))}}(e,t,r,n,a);case"A128GCM":case"A192GCM":case"A256GCM":return r instanceof Uint8Array&&x(r,parseInt(e.slice(1,4),10)),async function(e,t,r,n,a){let o;r instanceof Uint8Array?o=await i.subtle.importKey("raw",r,"AES-GCM",!1,["encrypt"]):(F(r,e,"encrypt"),o=r);const s=new Uint8Array(await i.subtle.encrypt({additionalData:a,iv:n,name:"AES-GCM",tagLength:128},o,t)),c=s.slice(-16);return{ciphertext:s.slice(0,-16),tag:c}}(e,t,r,n,a);default:throw new b("Unsupported JWE Content Encryption Algorithm")}};var ke=async function(e,t,r,n){switch(Pe(e,t,"decrypt"),e){case"dir":if(void 0!==r)throw new _("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new _("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!ee(n.epk))throw new _('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!se(t))throw new b("ECDH with the provided key is not allowed or not supported by your javascript runtime");const a=await Ce(n.epk,e);let i,o;if(void 0!==n.apu){if("string"!=typeof n.apu)throw new _('JOSE Header "apu" (Agreement PartyUInfo) invalid');i=g(n.apu)}if(void 0!==n.apv){if("string"!=typeof n.apv)throw new _('JOSE Header "apv" (Agreement PartyVInfo) invalid');o=g(n.apv)}const s=await oe(a,t,"ECDH-ES"===e?n.enc:e,"ECDH-ES"===e?pe(n.enc):parseInt(e.slice(-5,-2),10),i,o);if("ECDH-ES"===e)return s;if(void 0===r)throw new _("JWE Encrypted Key missing");return ie(e.slice(-6),s,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new _("JWE Encrypted Key missing");return(async(e,t,r)=>{if(!o(t))throw new TypeError(z(t,...Y));if(F(t,e,"decrypt","unwrapKey"),ue(e,t),t.usages.includes("decrypt"))return new Uint8Array(await i.subtle.decrypt(de(e),t,r));if(t.usages.includes("unwrapKey")){const n=await i.subtle.unwrapKey("raw",r,t,de(e),...te);return new Uint8Array(await i.subtle.exportKey("raw",n))}throw new TypeError('RSA-OAEP key "usages" must include "decrypt" or "unwrapKey" for this operation')})(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(void 0===r)throw new _("JWE Encrypted Key missing");if("number"!=typeof n.p2c)throw new _('JOSE Header "p2c" (PBES2 Count) missing or invalid');if("string"!=typeof n.p2s)throw new _('JOSE Header "p2s" (PBES2 Salt) missing or invalid');return(async(e,t,r,n,a)=>{const i=await ce(a,e,n,t);return ie(e.slice(-6),i,r)})(e,t,r,n.p2c,g(n.p2s));case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new _("JWE Encrypted Key missing");return ie(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":if(void 0===r)throw new _("JWE Encrypted Key missing");if("string"!=typeof n.iv)throw new _('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof n.tag)throw new _('JOSE Header "tag" (Authentication Tag) missing or invalid');return async function(e,t,r,n,a){const i=e.slice(0,7);return q(i,t,r,n,a,new Uint8Array(0))}(e,t,r,g(n.iv),g(n.tag));default:throw new b('Invalid or unsupported "alg" (JWE Algorithm) header value')}};var We=function(e,t,r,n,a){if(void 0!==a.crit&&void 0===n.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!n||void 0===n.crit)return new Set;if(!Array.isArray(n.crit)||0===n.crit.length||n.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of n.crit){if(!i.has(t))throw new b(`Extension Header Parameter "${t}" is not recognized`);if(void 0===a[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(i.get(t)&&void 0===n[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(n.crit)};var Te=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};async function Je(e,t,r){var n;if(!ee(e))throw new _("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new _("JOSE Header missing");if("string"!=typeof e.iv)throw new _("JWE Initialization Vector missing or incorrect type");if("string"!=typeof e.ciphertext)throw new _("JWE Ciphertext missing or incorrect type");if("string"!=typeof e.tag)throw new _("JWE Authentication Tag missing or incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new _("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new _("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new _("JWE AAD incorrect type");if(void 0!==e.header&&!ee(e.header))throw new _("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!ee(e.unprotected))throw new _("JWE Per-Recipient Unprotected Header incorrect type");let a;if(e.protected){const t=g(e.protected);try{a=JSON.parse(d.decode(t))}catch(e){throw new _("JWE Protected Header is invalid")}}if(!Q(a,e.header,e.unprotected))throw new _("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");const i={...a,...e.header,...e.unprotected};if(We(_,new Map,null==r?void 0:r.crit,a,i),void 0!==i.zip){if(!a||!a.zip)throw new _('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==i.zip)throw new b('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:o,enc:s}=i;if("string"!=typeof o||!o)throw new _("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof s||!s)throw new _("missing JWE Encryption Algorithm (enc) in JWE Header");const p=r&&Te("keyManagementAlgorithms",r.keyManagementAlgorithms),h=r&&Te("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(p&&!p.has(o))throw new v('"alg" (Algorithm) Header Parameter not allowed');if(h&&!h.has(s))throw new v('"enc" (Encryption Algorithm) Header Parameter not allowed');let l;void 0!==e.encrypted_key&&(l=g(e.encrypted_key));let y,w=!1;"function"==typeof t&&(t=await t(a,e),w=!0);try{y=await ke(o,t,l,i)}catch(e){if(e instanceof TypeError)throw e;y=he(s)}const f=g(e.iv),m=g(e.tag),E=c.encode(null!==(n=e.protected)&&void 0!==n?n:"");let A;A=void 0!==e.aad?u(E,c.encode("."),c.encode(e.aad)):E;let S=await q(s,y,g(e.ciphertext),f,m,A);"DEF"===i.zip&&(S=await((null==r?void 0:r.inflateRaw)||X)(S));const H={plaintext:S};return void 0!==e.protected&&(H.protectedHeader=a),void 0!==e.aad&&(H.additionalAuthenticatedData=g(e.aad)),void 0!==e.unprotected&&(H.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(H.unprotectedHeader=e.header),w?{...H,key:t}:H}async function Oe(e,t,r){if(e instanceof Uint8Array&&(e=d.decode(e)),"string"!=typeof e)throw new _("Compact JWE must be a string or Uint8Array");const{0:n,1:a,2:i,3:o,4:s,length:c}=e.split(".");if(5!==c)throw new _("Invalid Compact JWE");const u=await Je({ciphertext:o,iv:i||void 0,protected:n||void 0,tag:s||void 0,encrypted_key:a||void 0},t,r),p={plaintext:u.plaintext,protectedHeader:u.protectedHeader};return"function"==typeof t?{...p,key:u.key}:p}async function Re(e,t,r){if(!ee(e))throw new _("General JWE must be an object");if(!Array.isArray(e.recipients)||!e.recipients.every(ee))throw new _("JWE Recipients missing or incorrect type");if(!e.recipients.length)throw new _("JWE Recipients has no members");for(const n of e.recipients)try{return await Je({aad:e.aad,ciphertext:e.ciphertext,encrypted_key:n.encrypted_key,header:n.header,iv:e.iv,protected:e.protected,tag:e.tag,unprotected:e.unprotected},t,r)}catch(e){}throw new H}var De=async e=>{if(e instanceof Uint8Array)return{kty:"oct",k:f(e)};if(!o(e))throw new TypeError(z(e,...Y,"Uint8Array"));if(!e.extractable)throw new TypeError("non-extractable CryptoKey cannot be exported as a JWK");const{ext:t,key_ops:r,alg:n,use:a,...s}=await i.subtle.exportKey("jwk",e);return s};async function Ie(e){return(e=>ye("public","spki",e))(e)}async function Ue(e){return(e=>ye("private","pkcs8",e))(e)}async function xe(e){return De(e)}var Me=async function(e,t,r,n,a={}){let s,c,d;switch(Pe(e,r,"encrypt"),e){case"dir":d=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!se(r))throw new b("ECDH with the provided key is not allowed or not supported by your javascript runtime");const{apu:u,apv:p}=a;let{epk:h}=a;h||(h=(await async function(e){if(!o(e))throw new TypeError(z(e,...Y));return i.subtle.generateKey(e.algorithm,!0,["deriveBits"])}(r)).privateKey);const{x:l,y:y,crv:w,kty:m}=await xe(h),g=await oe(r,h,"ECDH-ES"===e?t:e,"ECDH-ES"===e?pe(t):parseInt(e.slice(-5,-2),10),u,p);if(c={epk:{x:l,crv:w,kty:m}},"EC"===m&&(c.epk.y=y),u&&(c.apu=f(u)),p&&(c.apv=f(p)),"ECDH-ES"===e){d=g;break}d=n||he(t);const E=e.slice(-6);s=await ae(E,g,d);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":d=n||he(t),s=await(async(e,t,r)=>{if(!o(t))throw new TypeError(z(t,...Y));if(F(t,e,"encrypt","wrapKey"),ue(e,t),t.usages.includes("encrypt"))return new Uint8Array(await i.subtle.encrypt(de(e),t,r));if(t.usages.includes("wrapKey")){const n=await i.subtle.importKey("raw",r,...te);return new Uint8Array(await i.subtle.wrapKey("raw",n,t,de(e)))}throw new TypeError('RSA-OAEP key "usages" must include "encrypt" or "wrapKey" for this operation')})(e,r,d);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{d=n||he(t);const{p2c:i,p2s:o}=a;({encryptedKey:s,...c}=await(async(e,t,r,n=2048,a=R(new Uint8Array(16)))=>{const i=await ce(a,e,n,t);return{encryptedKey:await ae(e.slice(-6),i,r),p2c:n,p2s:f(a)}})(e,r,d,i,o));break}case"A128KW":case"A192KW":case"A256KW":d=n||he(t),s=await ae(e,r,d);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{d=n||he(t);const{iv:i}=a;({encryptedKey:s,...c}=await async function(e,t,r,n){const a=e.slice(0,7);n||(n=I(a));const{ciphertext:i,tag:o}=await Ke(a,r,t,n,new Uint8Array(0));return{encryptedKey:i,iv:f(n),tag:f(o)}}(e,r,d,i));break}default:throw new b('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:d,encryptedKey:s,parameters:c}};const Ne=Symbol();class je{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("plaintext must be an instance of Uint8Array");this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new _("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!Q(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new _("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(We(_,new Map,null==t?void 0:t.crit,this._protectedHeader,r),void 0!==r.zip){if(!this._protectedHeader||!this._protectedHeader.zip)throw new _('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==r.zip)throw new b('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}const{alg:n,enc:a}=r;if("string"!=typeof n||!n)throw new _('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof a||!a)throw new _('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');let i,o,s,p,h,l,y;if("dir"===n){if(this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Encryption")}else if("ECDH-ES"===n&&this._cek)throw new TypeError("setContentEncryptionKey cannot be called when using Direct Key Agreement");{let r;({cek:o,encryptedKey:i,parameters:r}=await Me(n,a,e,this._cek,this._keyManagementParameters)),r&&(t&&Ne in t?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...r}:this.setUnprotectedHeader(r):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...r}:this.setProtectedHeader(r))}if(this._iv||(this._iv=I(a)),p=this._protectedHeader?c.encode(f(JSON.stringify(this._protectedHeader))):c.encode(""),this._aad?(h=f(this._aad),s=u(p,c.encode("."),c.encode(h))):s=p,"DEF"===r.zip){const e=await((null==t?void 0:t.deflateRaw)||Z)(this._plaintext);({ciphertext:l,tag:y}=await Ke(a,e,o,this._iv,s))}else({ciphertext:l,tag:y}=await Ke(a,this._plaintext,o,this._iv,s));const w={ciphertext:f(l),iv:f(this._iv),tag:f(y)};return i&&(w.encrypted_key=f(i)),h&&(w.aad=h),this._protectedHeader&&(w.protected=d.decode(p)),this._sharedUnprotectedHeader&&(w.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(w.header=this._unprotectedHeader),w}}class Be{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addRecipient(...e){return this.parent.addRecipient(...e)}encrypt(...e){return this.parent.encrypt(...e)}done(){return this.parent}}class Ge{constructor(e){this._recipients=[],this._plaintext=e}addRecipient(e,t){const r=new Be(this,e,{crit:null==t?void 0:t.crit});return this._recipients.push(r),r}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setSharedUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}async encrypt(e){var t,r,n;if(!this._recipients.length)throw new _("at least one recipient must be added");if(e={deflateRaw:null==e?void 0:e.deflateRaw},1===this._recipients.length){const[t]=this._recipients,r=await new je(this._plaintext).setAdditionalAuthenticatedData(this._aad).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(t.unprotectedHeader).encrypt(t.key,{...t.options,...e});let n={ciphertext:r.ciphertext,iv:r.iv,recipients:[{}],tag:r.tag};return r.aad&&(n.aad=r.aad),r.protected&&(n.protected=r.protected),r.unprotected&&(n.unprotected=r.unprotected),r.encrypted_key&&(n.recipients[0].encrypted_key=r.encrypted_key),r.header&&(n.recipients[0].header=r.header),n}let a;for(let e=0;e<this._recipients.length;e++){const t=this._recipients[e];if(!Q(this._protectedHeader,this._unprotectedHeader,t.unprotectedHeader))throw new _("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader,...t.unprotectedHeader},{alg:n}=r;if("string"!=typeof n||!n)throw new _('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("dir"===n||"ECDH-ES"===n)throw new _('"dir" and "ECDH-ES" alg may only be used with a single recipient');if("string"!=typeof r.enc||!r.enc)throw new _('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if(a){if(a!==r.enc)throw new _('JWE "enc" (Encryption Algorithm) Header Parameter must be the same for all recipients')}else a=r.enc;if(We(_,new Map,t.options.crit,this._protectedHeader,r),!(void 0===r.zip||this._protectedHeader&&this._protectedHeader.zip))throw new _('JWE "zip" (Compression Algorithm) Header MUST be integrity protected')}const i=he(a);let o={ciphertext:"",iv:"",recipients:[],tag:""};for(let s=0;s<this._recipients.length;s++){const c=this._recipients[s],d={};o.recipients.push(d);const u={...this._protectedHeader,...this._unprotectedHeader,...c.unprotectedHeader}.alg.startsWith("PBES2")?2048+s:void 0;if(0===s){const t=await new je(this._plaintext).setAdditionalAuthenticatedData(this._aad).setContentEncryptionKey(i).setProtectedHeader(this._protectedHeader).setSharedUnprotectedHeader(this._unprotectedHeader).setUnprotectedHeader(c.unprotectedHeader).setKeyManagementParameters({p2c:u}).encrypt(c.key,{...c.options,...e,[Ne]:!0});o.ciphertext=t.ciphertext,o.iv=t.iv,o.tag=t.tag,t.aad&&(o.aad=t.aad),t.protected&&(o.protected=t.protected),t.unprotected&&(o.unprotected=t.unprotected),d.encrypted_key=t.encrypted_key,t.header&&(d.header=t.header);continue}const{encryptedKey:p,parameters:h}=await Me((null===(t=c.unprotectedHeader)||void 0===t?void 0:t.alg)||(null===(r=this._protectedHeader)||void 0===r?void 0:r.alg)||(null===(n=this._unprotectedHeader)||void 0===n?void 0:n.alg),a,c.key,i,{p2c:u});d.encrypted_key=f(p),(c.unprotectedHeader||h)&&(d.header={...c.unprotectedHeader,...h})}return o}}function Le(e,t){const r="SHA-"+e.slice(-3);switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case(Object(N.a)()||Object(N.b)())&&"EdDSA":const{namedCurve:n}=t;return{name:n,namedCurve:n};default:throw new b(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}function Ve(e,t,r){if(o(t))return V(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(z(t,...Y));return i.subtle.importKey("raw",t,{hash:"SHA-"+e.slice(-3),name:"HMAC"},!1,[r])}throw new TypeError(z(t,...Y,"Uint8Array"))}var Fe=async(e,t,r,n)=>{const a=await Ve(e,t,"verify");ue(e,a);const o=Le(e,a.algorithm);try{return await i.subtle.verify(o,a,r,n)}catch(e){return!1}};async function ze(e,t,r){var n;if(!ee(e))throw new C("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new C('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new C("JWS Protected Header incorrect type");if(void 0===e.payload)throw new C("JWS Payload missing");if("string"!=typeof e.signature)throw new C("JWS Signature missing or incorrect type");if(void 0!==e.header&&!ee(e.header))throw new C("JWS Unprotected Header incorrect type");let a={};if(e.protected){const t=g(e.protected);try{a=JSON.parse(d.decode(t))}catch(e){throw new C("JWS Protected Header is invalid")}}if(!Q(a,e.header))throw new C("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const i={...a,...e.header};let o=!0;if(We(C,new Map([["b64",!0]]),null==r?void 0:r.crit,a,i).has("b64")&&(o=a.b64,"boolean"!=typeof o))throw new C('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:s}=i;if("string"!=typeof s||!s)throw new C('JWS "alg" (Algorithm) Header Parameter missing or invalid');const p=r&&Te("algorithms",r.algorithms);if(p&&!p.has(s))throw new v('"alg" (Algorithm) Header Parameter not allowed');if(o){if("string"!=typeof e.payload)throw new C("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new C("JWS Payload must be a string or an Uint8Array instance");let h=!1;"function"==typeof t&&(t=await t(a,e),h=!0),Pe(s,t,"verify");const l=u(c.encode(null!==(n=e.protected)&&void 0!==n?n:""),c.encode("."),"string"==typeof e.payload?c.encode(e.payload):e.payload),y=g(e.signature);if(!await Fe(s,t,y,l))throw new O;let w;w=o?g(e.payload):"string"==typeof e.payload?c.encode(e.payload):e.payload;const f={payload:w};return void 0!==e.protected&&(f.protectedHeader=a),void 0!==e.header&&(f.unprotectedHeader=e.header),h?{...f,key:t}:f}async function $e(e,t,r){if(e instanceof Uint8Array&&(e=d.decode(e)),"string"!=typeof e)throw new C("Compact JWS must be a string or Uint8Array");const{0:n,1:a,2:i,length:o}=e.split(".");if(3!==o)throw new C("Invalid Compact JWS");const s=await ze({payload:a,protected:n,signature:i},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}async function Ye(e,t,r){if(!ee(e))throw new C("General JWS must be an object");if(!Array.isArray(e.signatures)||!e.signatures.every(ee))throw new C("JWS Signatures missing or incorrect type");for(const n of e.signatures)try{return await ze({header:n.header,payload:e.payload,protected:n.protected,signature:n.signature},t,r)}catch(e){}throw new O}var qe=e=>Math.floor(e.getTime()/1e3);const Xe=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i;var Ze=e=>{const t=Xe.exec(e);if(!t)throw new TypeError("Invalid time period format");const r=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(60*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(3600*r);case"day":case"days":case"d":return Math.round(86400*r);case"week":case"weeks":case"w":return Math.round(604800*r);default:return Math.round(31557600*r)}};const Qe=e=>e.toLowerCase().replace(/^application\//,"");var et=(e,t,r={})=>{const{typ:n}=r;if(n&&("string"!=typeof e.typ||Qe(e.typ)!==Qe(n)))throw new A('unexpected "typ" JWT header value',"typ","check_failed");let a;try{a=JSON.parse(d.decode(t))}catch(e){}if(!ee(a))throw new P("JWT Claims Set must be a top-level JSON object");const{issuer:i}=r;if(i&&!(Array.isArray(i)?i:[i]).includes(a.iss))throw new A('unexpected "iss" claim value',"iss","check_failed");const{subject:o}=r;if(o&&a.sub!==o)throw new A('unexpected "sub" claim value',"sub","check_failed");const{audience:s}=r;if(s&&(c=a.aud,u="string"==typeof s?[s]:s,!("string"==typeof c?u.includes(c):Array.isArray(c)&&u.some(Set.prototype.has.bind(new Set(c))))))throw new A('unexpected "aud" claim value',"aud","check_failed");var c,u;let p;switch(typeof r.clockTolerance){case"string":p=Ze(r.clockTolerance);break;case"number":p=r.clockTolerance;break;case"undefined":p=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:h}=r,l=qe(h||new Date);if((void 0!==a.iat||r.maxTokenAge)&&"number"!=typeof a.iat)throw new A('"iat" claim must be a number',"iat","invalid");if(void 0!==a.nbf){if("number"!=typeof a.nbf)throw new A('"nbf" claim must be a number',"nbf","invalid");if(a.nbf>l+p)throw new A('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==a.exp){if("number"!=typeof a.exp)throw new A('"exp" claim must be a number',"exp","invalid");if(a.exp<=l-p)throw new S('"exp" claim timestamp check failed',"exp","check_failed")}if(r.maxTokenAge){const e=l-a.iat;if(e-p>("number"==typeof r.maxTokenAge?r.maxTokenAge:Ze(r.maxTokenAge)))throw new S('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-p)throw new A('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return a};async function tt(e,t,r){var n;const a=await $e(e,t,r);if((null===(n=a.protectedHeader.crit)||void 0===n?void 0:n.includes("b64"))&&!1===a.protectedHeader.b64)throw new P("JWTs MUST NOT use unencoded payload");const i={payload:et(a.protectedHeader,a.payload,r),protectedHeader:a.protectedHeader};return"function"==typeof t?{...i,key:a.key}:i}async function rt(e,t,r){const n=await Oe(e,t,r),a=et(n.protectedHeader,n.plaintext,r),{protectedHeader:i}=n;if(void 0!==i.iss&&i.iss!==a.iss)throw new A('replicated "iss" claim header parameter mismatch',"iss","mismatch");if(void 0!==i.sub&&i.sub!==a.sub)throw new A('replicated "sub" claim header parameter mismatch',"sub","mismatch");if(void 0!==i.aud&&JSON.stringify(i.aud)!==JSON.stringify(a.aud))throw new A('replicated "aud" claim header parameter mismatch',"aud","mismatch");const o={payload:a,protectedHeader:i};return"function"==typeof t?{...o,key:n.key}:o}class nt{constructor(e){this._flattened=new je(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){const r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}var at=async(e,t,r)=>{const n=await Ve(e,t,"sign");ue(e,n);const a=await i.subtle.sign(Le(e,n.algorithm),n,r);return new Uint8Array(a)};class it{constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this._payload=e}setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}async sign(e,t){if(!this._protectedHeader&&!this._unprotectedHeader)throw new C("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!Q(this._protectedHeader,this._unprotectedHeader))throw new C("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const r={...this._protectedHeader,...this._unprotectedHeader};let n=!0;if(We(C,new Map([["b64",!0]]),null==t?void 0:t.crit,this._protectedHeader,r).has("b64")&&(n=this._protectedHeader.b64,"boolean"!=typeof n))throw new C('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:a}=r;if("string"!=typeof a||!a)throw new C('JWS "alg" (Algorithm) Header Parameter missing or invalid');Pe(a,e,"sign");let i,o=this._payload;n&&(o=c.encode(f(o))),i=this._protectedHeader?c.encode(f(JSON.stringify(this._protectedHeader))):c.encode("");const s=u(i,c.encode("."),o),p=await at(a,e,s),h={signature:f(p),payload:""};return n&&(h.payload=d.decode(o)),this._unprotectedHeader&&(h.header=this._unprotectedHeader),this._protectedHeader&&(h.protected=d.decode(i)),h}}class ot{constructor(e){this._flattened=new it(e)}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}async sign(e,t){const r=await this._flattened.sign(e,t);if(void 0===r.payload)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}class st{constructor(e,t,r){this.parent=e,this.key=t,this.options=r}setProtectedHeader(e){if(this.protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this.protectedHeader=e,this}setUnprotectedHeader(e){if(this.unprotectedHeader)throw new TypeError("setUnprotectedHeader can only be called once");return this.unprotectedHeader=e,this}addSignature(...e){return this.parent.addSignature(...e)}sign(...e){return this.parent.sign(...e)}done(){return this.parent}}class ct{constructor(e){this._signatures=[],this._payload=e}addSignature(e,t){const r=new st(this,e,t);return this._signatures.push(r),r}async sign(){if(!this._signatures.length)throw new C("at least one signature must be added");const e={signatures:[],payload:""};for(let t=0;t<this._signatures.length;t++){const r=this._signatures[t],n=new it(this._payload);n.setProtectedHeader(r.protectedHeader),n.setUnprotectedHeader(r.unprotectedHeader);const{payload:a,...i}=await n.sign(r.key,r.options);if(0===t)e.payload=a;else if(e.payload!==a)throw new C("inconsistent use of JWS Unencoded Payload Option (RFC7797)");e.signatures.push(i)}return e}}class dt{constructor(e){if(!ee(e))throw new TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return this._payload="number"==typeof e?{...this._payload,nbf:e}:{...this._payload,nbf:qe(new Date)+Ze(e)},this}setExpirationTime(e){return this._payload="number"==typeof e?{...this._payload,exp:e}:{...this._payload,exp:qe(new Date)+Ze(e)},this}setIssuedAt(e){return this._payload=void 0===e?{...this._payload,iat:qe(new Date)}:{...this._payload,iat:e},this}}class ut extends dt{setProtectedHeader(e){return this._protectedHeader=e,this}async sign(e,t){var r;const n=new ot(c.encode(JSON.stringify(this._payload)));if(n.setProtectedHeader(this._protectedHeader),Array.isArray(null===(r=this._protectedHeader)||void 0===r?void 0:r.crit)&&this._protectedHeader.crit.includes("b64")&&!1===this._protectedHeader.b64)throw new P("JWTs MUST NOT use unencoded payload");return n.sign(e,t)}}class pt extends dt{setProtectedHeader(e){if(this._protectedHeader)throw new TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw new TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw new TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw new TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){const r=new nt(c.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}const ht=(e,t)=>{if("string"!=typeof e||!e)throw new K(t+" missing or invalid")};async function lt(e,t="sha256"){if(!ee(e))throw new TypeError("JWK must be an object");if("sha256"!==t&&"sha384"!==t&&"sha512"!==t)throw new TypeError('digestAlgorithm must one of "sha256", "sha384", or "sha512"');let r;switch(e.kty){case"EC":ht(e.crv,'"crv" (Curve) Parameter'),ht(e.x,'"x" (X Coordinate) Parameter'),ht(e.y,'"y" (Y Coordinate) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":ht(e.crv,'"crv" (Subtype of Key Pair) Parameter'),ht(e.x,'"x" (Public Key) Parameter'),r={crv:e.crv,kty:e.kty,x:e.x};break;case"RSA":ht(e.e,'"e" (Exponent) Parameter'),ht(e.n,'"n" (Modulus) Parameter'),r={e:e.e,kty:e.kty,n:e.n};break;case"oct":ht(e.k,'"k" (Key Value) Parameter'),r={k:e.k,kty:e.kty};break;default:throw new b('"kty" (Key Type) Parameter missing or unsupported')}const n=c.encode(JSON.stringify(r));return f(await s(t,n))}async function yt(e,t){const r={...e,...t.header};if(!ee(r.jwk))throw new C('"jwk" (JSON Web Key) Header Parameter must be a JSON object');const n=await Ce({...r.jwk,ext:!0},r.alg,!0);if(n instanceof Uint8Array||"public"!==n.type)throw new C('"jwk" (JSON Web Key) Header Parameter must be a public key');return n}function wt(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(ft)}function ft(e){return ee(e)}class mt{constructor(e){if(this._cached=new WeakMap,!wt(e))throw new k("JSON Web Key Set malformed");var t;this._jwks=(t=e,"function"==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t)))}async getKey(e,t){const{alg:r,kid:n}={...e,...t.header},a=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new b('Unsupported "alg" value for a JSON Web Key Set')}}(r),i=this._jwks.keys.filter(e=>{let t=a===e.kty;if(t&&"string"==typeof n&&(t=n===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t&&"EdDSA"===r&&(t="Ed25519"===e.crv||"Ed448"===e.crv),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv}return t}),{0:o,length:s}=i;if(0===s)throw new W;if(1!==s)throw new T;const c=this._cached.get(o)||this._cached.set(o,{}).get(o);if(void 0===c[r]){const e=await Ce({...o,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new k("JSON Web Key Set members must be public keys");c[r]=e}return c[r]}}function gt(e){return mt.prototype.getKey.bind(new mt(e))}var Et=async(e,t,r)=>{let n,a,i=!1;"function"==typeof AbortController&&(n=new AbortController,a=setTimeout(()=>{i=!0,n.abort()},t));const o=await fetch(e.href,{signal:n?n.signal:void 0,redirect:"manual",headers:r.headers}).catch(e=>{if(i)throw new J;throw e});if(void 0!==a&&clearTimeout(a),200!==o.status)throw new E("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await o.json()}catch(e){throw new E("Failed to parse the JSON Web Key Set HTTP response as JSON")}};class At extends mt{constructor(e,t){if(super({keys:[]}),this._jwks=void 0,!(e instanceof URL))throw new TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:null==t?void 0:t.agent,headers:null==t?void 0:t.headers},this._timeoutDuration="number"==typeof(null==t?void 0:t.timeoutDuration)?null==t?void 0:t.timeoutDuration:5e3,this._cooldownDuration="number"==typeof(null==t?void 0:t.cooldownDuration)?null==t?void 0:t.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof(null==t?void 0:t.cacheMaxAge)?null==t?void 0:t.cacheMaxAge:6e5}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._jwks&&this.fresh()||await this.reload();try{return await super.getKey(e,t)}catch(r){if(r instanceof W&&!1===this.coolingDown())return await this.reload(),super.getKey(e,t);throw r}}async reload(){if(this._pendingFetch&&Object(N.a)())return new Promise(e=>{const t=()=>{void 0===this._pendingFetch?e():setTimeout(t,5)};t()});this._pendingFetch||(this._pendingFetch=Et(this._url,this._timeoutDuration,this._options).then(e=>{if(!wt(e))throw new k("JSON Web Key Set malformed");this._jwks={keys:e.keys},this._jwksTimestamp=Date.now(),this._pendingFetch=void 0}).catch(e=>{throw this._pendingFetch=void 0,e})),await this._pendingFetch}}function St(e,t){return At.prototype.getKey.bind(new At(e,t))}class vt extends dt{encode(){return`${f(JSON.stringify({alg:"none"}))}.${f(JSON.stringify(this._payload))}.`}static decode(e,t){if("string"!=typeof e)throw new P("Unsecured JWT must be a string");const{0:r,1:n,2:a,length:i}=e.split(".");if(3!==i||""!==a)throw new P("Invalid Unsecured JWT");let o;try{if(o=JSON.parse(d.decode(g(r))),"none"!==o.alg)throw new Error}catch(e){throw new P("Invalid Unsecured JWT")}return{payload:et(o,g(n),t),header:o}}}const bt=f,Ht=g;function _t(e){let t;if("string"==typeof e){const r=e.split(".");3!==r.length&&5!==r.length||([t]=r)}else if("object"==typeof e&&e){if(!("protected"in e))throw new TypeError("Token does not contain a Protected Header");t=e.protected}try{if("string"!=typeof t||!t)throw new Error;const e=JSON.parse(d.decode(Ht(t)));if(!ee(e))throw new Error;return e}catch(e){throw new TypeError("Invalid Token or Protected Header formatting")}}function Ct(e){if("string"!=typeof e)throw new P("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new P("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new P("Invalid JWT");if(!t)throw new P("JWTs must contain a payload");let n,a;try{n=Ht(t)}catch(e){throw new P("Failed to parse the base64url encoded payload")}try{a=JSON.parse(d.decode(n))}catch(e){throw new P("Failed to parse the decoded payload as JSON")}if(!ee(a))throw new P("Invalid JWT Claims Set");return a}function Pt(e){var t;const r=null!==(t=null==e?void 0:e.modulusLength)&&void 0!==t?t:2048;if("number"!=typeof r||r<2048)throw new b("Invalid or unsupported modulusLength option provided, 2048 bits or larger keys must be used");return r}async function Kt(e,t){return async function(e,t){var r,n;let a,o;switch(e){case"PS256":case"PS384":case"PS512":a={name:"RSA-PSS",hash:"SHA-"+e.slice(-3),publicExponent:new Uint8Array([1,0,1]),modulusLength:Pt(t)},o=["sign","verify"];break;case"RS256":case"RS384":case"RS512":a={name:"RSASSA-PKCS1-v1_5",hash:"SHA-"+e.slice(-3),publicExponent:new Uint8Array([1,0,1]),modulusLength:Pt(t)},o=["sign","verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":a={name:"RSA-OAEP",hash:"SHA-"+(parseInt(e.slice(-3),10)||1),publicExponent:new Uint8Array([1,0,1]),modulusLength:Pt(t)},o=["decrypt","unwrapKey","encrypt","wrapKey"];break;case"ES256":a={name:"ECDSA",namedCurve:"P-256"},o=["sign","verify"];break;case"ES384":a={name:"ECDSA",namedCurve:"P-384"},o=["sign","verify"];break;case"ES512":a={name:"ECDSA",namedCurve:"P-521"},o=["sign","verify"];break;case(Object(N.a)()||Object(N.b)())&&"EdDSA":switch(null==t?void 0:t.crv){case void 0:case"Ed25519":a={name:"NODE-ED25519",namedCurve:"NODE-ED25519"},o=["sign","verify"];break;case Object(N.b)()&&"Ed448":a={name:"NODE-ED448",namedCurve:"NODE-ED448"},o=["sign","verify"];break;default:throw new b("Invalid or unsupported crv option provided, supported values are Ed25519 and Ed448")}break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":a={name:"ECDH",namedCurve:null!==(r=null==t?void 0:t.crv)&&void 0!==r?r:"P-256"},o=["deriveKey","deriveBits"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return i.subtle.generateKey(a,null!==(n=null==t?void 0:t.extractable)&&void 0!==n&&n,o)}(e,t)}async function kt(e,t){return async function(e,t){var r;let n,a,o;switch(e){case"HS256":case"HS384":case"HS512":n=parseInt(e.slice(-3),10),a={name:"HMAC",hash:"SHA-"+n,length:n},o=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return n=parseInt(e.slice(-3),10),R(new Uint8Array(n>>3));case"A128KW":case"A192KW":case"A256KW":n=parseInt(e.slice(1,4),10),a={name:"AES-KW",length:n},o=["wrapKey","unwrapKey"];break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":case"A128GCM":case"A192GCM":case"A256GCM":n=parseInt(e.slice(1,4),10),a={name:"AES-GCM",length:n},o=["encrypt","decrypt"];break;default:throw new b('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}return i.subtle.generateKey(a,null!==(r=null==t?void 0:t.extractable)&&void 0!==r&&r,o)}(e,t)}},function(e,t,r){addEventListener("fetch",e=>{e.respondWith(async function(e){if("OPTIONS"===e.method)return function(e){return null!==e.headers.get("Origin")&&null!==e.headers.get("Access-Control-Request-Method")&&null!==e.headers.get("Access-Control-Request-Headers")?new Response(null,{headers:n}):new Response(null,{headers:{Allow:"GET, HEAD, POST, OPTIONS"}})}(e);const{authenticate:t}=r(3);if(!await t(e))return new Response(null,{status:403,statusText:"Forbidden, user does not have permission",headers:{...n}});return"GET"===e.method?async function(e){const t=await MOVIE_KV.list(),r=JSON.parse(JSON.stringify(t.keys));let a=[];try{for(let e=0;e<r.length;e++){const t=r[e].name,n=await MOVIE_KV.get(t);a.push(n)}}catch(e){console.log(e)}return new Response(JSON.stringify(a),{headers:{...n}})}():"POST"===e.method?async function(e){const t=await e.json(),r=JSON.parse(t),i=await MOVIE_KV.list(),o=JSON.parse(JSON.stringify(i.keys));try{a(r,o)}catch(e){console.log(e)}return new Response(JSON.stringify(t),{headers:{...n}})}(e):"HEAD"===e.method?new Response(null,{status:200,headers:{...n}}):new Response(null,{status:405,statusText:"Method Not Allowed"})}(e.request))});const n={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type,Authorization,Access-Control-Allow-Origin"};async function a(e,t){for(let e=0;e<t.length;e++){const r=t[e].name;await MOVIE_KV.get(r);movies.filter(()=>{})}}},function(e,t,r){"use strict";async function n(e){const{getAllowList:t}=r(4),n=e.headers.get("Authorization"),{jwtVerify:a}=r(1),{createRemoteJWKSet:i}=r(1),o=(await fetch("https://dev-qy-iakti.us.auth0.com/.well-known/jwks.json"),i(new URL("https://dev-qy-iakti.us.auth0.com/.well-known/jwks.json"))),{payload:s,protectedHeader:c}=await a(n.replaceAll('"',""),o,{iss:"dev-qy-iakti.us.auth0.com/",aud:"eEBy63jCkRcKBsKpAfOWit5hg8JgZzpG"});return t().includes(s.nickname)}r.r(t),r.d(t,"authenticate",(function(){return n}))},function(e,t,r){"use strict";function n(){return["otavio.nathanael"]}r.r(t),r.d(t,"getAllowList",(function(){return n}))},function(e,t){var r,n,a=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function s(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var c,d=[],u=!1,p=-1;function h(){u&&c&&(u=!1,c.length?d=c.concat(d):p=-1,d.length&&l())}function l(){if(!u){var e=s(h);u=!0;for(var t=d.length;t;){for(c=d,d=[];++p<t;)c&&c[p].run();p=-1,t=d.length}c=null,u=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function y(e,t){this.fun=e,this.array=t}function w(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];d.push(new y(e,t)),1!==d.length||u||s(l)},y.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=w,a.addListener=w,a.once=w,a.off=w,a.removeListener=w,a.removeAllListeners=w,a.emit=w,a.prependListener=w,a.prependOnceListener=w,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}}]);